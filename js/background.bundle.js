(() => { try { importScripts("crypto-js.min.js", "zalo_api.bundle.js") } catch (t) { console.error(t) } let t, e, r, a = !1; async function o(t) { try { const e = `rnd=${Date.now()}${Math.floor(1e3 * Math.random())}`, r = t.includes("?") ? `${t}&${e}` : `${t}?${e}`, a = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(r)}`); if (!a.ok) throw new Error("Failed to shorten the URL"); return await a.text() } catch (e) { return console.error(e), t } } let s = !1; chrome.storage.sync.get("translateSettings", (t => { if (t.translateSettings && void 0 !== t.translateSettings.autoShortLink) { const e = t.translateSettings.autoShortLink; s = e } })), chrome.storage.onChanged.addListener(((t, e) => { if ("sync" === e && t.translateSettings) { const e = t.translateSettings.newValue; e && void 0 !== e.autoShortLink && (s = e.autoShortLink) } })), chrome.runtime.onMessage.addListener(((n, c, i) => { if ("GET_FRIENDS_API" === n.action) return (async () => { try { let t = n.tabId, e = !1; if (t) try { const r = await chrome.tabs.get(t); r && r.url && r.url.includes("chat.zalo.me") && (e = !0) } catch (t) { } if (!e) { const e = await chrome.tabs.query({ url: "*://chat.zalo.me/*" }); if (!(e.length > 0)) throw new Error("Không tìm thấy tab Zalo. Vui lòng mở Zalo Web."); t = e[0].id } const r = await executeGetFriends(t), a = Array.isArray(r) ? r : r.data || [], o = a.length; i({ success: !0, data: a, count: o }) } catch (t) { console.error("Executor Error:", t), i({ success: !1, error: t.message }) } })(), !0; if ("GET_LABELS_API" === n.action) return (async () => { try { let t = n.tabId, e = !1; if (t) try { const r = await chrome.tabs.get(t); r && r.url && r.url.includes("chat.zalo.me") && (e = !0) } catch (t) { } if (!e) { const e = await chrome.tabs.query({ url: "*://chat.zalo.me/*" }); if (!(e.length > 0)) throw new Error("Không tìm thấy tab Zalo. Vui lòng mở Zalo Web."); t = e[0].id } const r = await executeGetLabels(t); r.success ? i({ success: !0, data: r.data }) : i({ success: !1, error: r.error }) } catch (t) { console.error("Label Executor Error:", t), i({ success: !1, error: t.message }) } })(), !0; if ("GET_GROUPS_API" === n.action) return (async () => { try { let t = n.tabId, e = !1; if (t) try { const r = await chrome.tabs.get(t); r && r.url && r.url.includes("chat.zalo.me") && (e = !0) } catch (t) { } if (!e) { const e = await chrome.tabs.query({ url: "*://chat.zalo.me/*" }); if (!(e.length > 0)) throw new Error("Không tìm thấy tab Zalo. Vui lòng mở Zalo Web."); t = e[0].id } const r = await executeGetGroups(t); i(r) } catch (t) { console.error("Group API Executor Error:", t), i({ success: !1, error: t.message }) } })(), !0; if ("GET_GROUP_MEMBERS_API" === n.action) return (async () => { try { let t = n.tabId, e = !1; if (t) try { const r = await chrome.tabs.get(t); r && r.url && r.url.includes("chat.zalo.me") && (e = !0) } catch (t) { } if (!e) { const e = await chrome.tabs.query({ url: "*://chat.zalo.me/*" }); if (!(e.length > 0)) throw new Error("Không tìm thấy tab Zalo. Vui lòng mở Zalo Web."); t = e[0].id } const r = await executeGetGroupMembers(t, n.groupId); i(r) } catch (t) { console.error("Group Members API Executor Error:", t), i({ success: !1, error: t.message }) } })(), !0; if ("OPEN_GROUP_CHAT" === n.action) return (async () => { try { let t = n.tabId; const e = n.groupId; let r = !1; if (t) try { const e = await chrome.tabs.get(t); e && e.url && e.url.includes("chat.zalo.me") && (r = !0) } catch (t) { } if (!r) { const e = await chrome.tabs.query({ url: "*://chat.zalo.me/*" }); if (!(e.length > 0)) throw new Error("Không tìm thấy tab Zalo. Vui lòng mở Zalo Web."); t = e[0].id } const a = `https://chat.zalo.me/#/g/${e.startsWith("g") ? e.substring(1) : e}`; await chrome.tabs.update(t, { url: a }), await new Promise((t => setTimeout(t, 3e3))); const o = await executeGetGroupMembers(t, e); i(o) } catch (t) { console.error("Open Chat Executor Error:", t), i({ success: !1, error: t.message }) } })(), !0; if ("fetchHTML" === n.action) return fetch(n.url).then((t => { if (!t.ok) throw new Error("Network response was not ok"); return t.text() })).then((t => { i({ success: !0, html: t }) })).catch((t => { console.error("Error fetching content:", t), i({ success: !1, error: t.message, fallbackHTML: '\n            <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; padding: 40px 20px; text-align: center;">\n              <h2 style="color: #fff;">Không thể tải nội dung từ server</h2>\n              <p style="color: #D1D5DB;">Vui lòng thử lại sau hoặc liên hệ hỗ trợ kỹ thuật</p>\n            </div>\n          ' }) })), !0; if ("translate" === n.action) { let t = n.text; const e = n.targetLanguage || "en"; t = t.replace(/\n+/g, "\n"); const r = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${e}&dt=t&q=${encodeURIComponent(t)}`; return fetch(r).then((t => t.json())).then((t => { const e = t[0].map((t => t[0])).join(""), r = t[2]; i({ success: !0, translation: e, detectedSourceLanguage: r }) })).catch((t => { console.error("Lỗi dịch (background):", t), i({ success: !1, error: t.toString() }) })), !0 } if ("revokeToken" === n.action) return chrome.identity.getAuthToken({ interactive: !1 }, (function (t) { chrome.runtime.lastError || chrome.identity.removeCachedAuthToken({ token: t }, (function () { })) })), !0; if ("login" === n.action) return chrome.identity.getAuthToken({ interactive: !0 }, (t => { chrome.runtime.lastError ? (console.error(chrome.runtime.lastError), i({ success: !1, error: chrome.runtime.lastError })) : (i({ success: !0, token: t }), fetch("https://www.googleapis.com/oauth2/v2/userinfo", { method: "GET", headers: { Authorization: "Bearer " + t } }).then((t => t.json())).then((t => { i({ success: !0, userInfo: t }) })).catch((t => { i({ success: !1, error: t }) }))) })), !0; if ("getActiveTab" === n.message) return chrome.tabs.query({ active: !0, currentWindow: !0 }, (t => { t.length > 0 ? i({ tab: t[0] }) : i({ tab: null }) })), !0; if ("OPEN_CHAT_SUCCESS" === n.task && chrome.storage.local.get(["tabZalo"], (function (t) { !async function (t, e) { try { const e = await chrome.tabs.get(t); if (e && e.url && e.url.startsWith("chrome://")) return } catch (t) { } chrome.scripting.executeScript({ target: { tabId: t }, func: t => { const e = (t, e) => { const [r, a] = t.split(","), o = atob(a), s = new ArrayBuffer(o.length), n = new Uint8Array(s); for (let t = 0; t < o.length; t++)n[t] = o.charCodeAt(t); const c = r.split(";")[0].split(":")[1]; return new File([n], e, { type: c }) }; t.forEach((t => { const r = new DataTransfer, a = e(t.fileData, t.fileName); r.items.add(a); const o = (t, e) => new DragEvent(t, { bubbles: !0, cancelable: !0, dataTransfer: e }), s = document.getElementById("dragOverlayInputbox"); s ? ["dragstart", "dragenter", "dragover", "drop"].forEach((t => { const e = o(t, r); s.dispatchEvent(e) })) : console.error('Element with ID "chatInput" not found.') })) }, args: [e] }, (() => { setTimeout((() => { chrome.runtime.lastError ? console.error(chrome.runtime.lastError) : chrome.tabs.sendMessage(t, { task: "click_send_button" }) }), 3e3) })) }(t.tabZalo.id, r) })), "SEND_DUNG_THU_PHAN_MEM" == n.task && chrome.storage.local.get(["tabZalo"], (function (t) { const e = t.tabZalo.id; chrome.tabs.sendMessage(e, { task: "clickAddContact", phone: "0933913122", message: "THÔNG TIN ĐĂNG KÝ PHẦN MỀM ZALO MARKETING PRO \n" + n.info, isCheck: !1, isKetBan: !1 }, (t => { if (chrome.runtime.lastError) return reject(chrome.runtime.lastError); resolve(t) })) })), "SEND_MESSAGE_TO_FRIENDS" === n.task) chrome.storage.local.get(["settings"], (function (c) { let i = c.settings.delay, l = c.settings.delay1, h = c.settings.delay2, u = (c.settings.delay3, n.type); async function m(t) { return new Promise((e => setTimeout(e, t))) } async function g(r) { const a = r[0], n = r[1]; if (s) { let r = JSON.parse(JSON.stringify(e)); t.message = await async function (t) { const e = t.match(/(https?:\/\/[^\s]+)/g); if (!e) return t; let r = t; for (const t of e) { const e = await o(t); r = r.replace(t, e) } return r }(r) } try { const e = await new Promise(((t, e) => { chrome.storage.local.get(["tabZalo", "settings", "IS_GUI_HOA_DON"], (r => { if (chrome.runtime.lastError) return e(chrome.runtime.lastError); t(r) })) })), o = e.tabZalo.id, s = e.settings.isKiemTraHopLe, c = e.IS_GUI_HOA_DON; "KHACH_HANG" === u && await new Promise(((a, n) => { let i = r[0]; if (1 == c && (i = r[2]), !1 === function (t) { const e = t.replace(/[\s+]/g, ""); return !!/^(0|\+?84)?(3|5|7|8|9)(\d{8})$/.test(e) || !(!t || !t.toString().trim().startsWith("+") || t.toString().trim().startsWith("+84")) }(i)) { var l = { status: "error", phone: i, message: "Số điện thoại này không hợp lệ." }; return chrome.runtime.sendMessage({ task: "TRANGTHAI_SEND_MESSAGE", data: l }), n("Số điện thoại không hợp lệ.") } chrome.tabs.sendMessage(o, { task: "clickAddContact", item: r, phone: i, message: t.message, isCheck: s, isKetBan: e.settings.isKetBan }, (t => { if (chrome.runtime.lastError) return n(chrome.runtime.lastError); a(t) })) })), "BAN_BE" === u && await new Promise(((e, r) => { chrome.tabs.sendMessage(o, { task: "clickInputFriend", name: n, message: t.message, uid: a }, (t => { if (chrome.runtime.lastError) return r(chrome.runtime.lastError); e(t) })) })) } catch (t) { } } function d(t, e) { return new Promise((r => { let o, s = e / 1e3; o = setInterval((() => { if (a) return chrome.runtime.sendMessage({ task: "SLEEP_COUNT_DOWN", countdown: -1, item: t }), clearInterval(o), void r(); s > 0 ? (s--, chrome.runtime.sendMessage({ task: "SLEEP_COUNT_DOWN", countdown: s, item: t }, (t => { chrome.runtime.lastError && console.error("Runtime error:", chrome.runtime.lastError) }))) : (clearInterval(o), r()) }), 1e3) })) } a = !1, t = JSON.parse(JSON.stringify(n.data)), e = n.data.message, r = n.files, async function (t) { const e = 1e3 * Number(i); let r = 1e3 * Number(h); const o = Number(l); let s = 0; for (let n = 0; n < t.length; n++) { if (a) return; const c = t[n]; let i = `(${n + 1}/${t.length})`; if (chrome.runtime.sendMessage({ task: "CURRENT_PROCESSING_ITEM", data: i }, (t => { chrome.runtime.lastError })), 1 === n && chrome.runtime.sendMessage({ task: "PROCESSING_ITEM", data: c }, (t => { chrome.runtime.lastError })), await g(c), await m(3e3), s++, s % o == 0) { if (n + 1 < t.length) { let e = t[n + 1]; if (await d(e, r), a) return; chrome.runtime.sendMessage({ task: "PROCESSING_ITEM", data: e }, (t => { chrome.runtime.lastError })) } await m(700) } else { if (n + 1 < t.length) { let r = t[n + 1]; if (await d(r, e), a) return; chrome.runtime.sendMessage({ task: "PROCESSING_ITEM", data: r }, (t => { chrome.runtime.lastError })) } await m(700) } } chrome.runtime.sendMessage({ task: "FINISH_SEND_MESSAGE" }, (t => { chrome.runtime.lastError })) }(t.phone) })); else if ("stop_send_message" === n.task) a = !0; else if ("LOGOUT" === n.task) { l = "https://chat.zalo.me", chrome.cookies.getAll({ url: l }, (function (t) { t && 0 !== t.length && t.forEach((t => { let e = t.domain.startsWith(".") ? t.domain.substring(1) : t.domain, r = { url: `${t.secure ? "https://" : "http://"}${e}${t.path}`, name: t.name }; chrome.cookies.remove(r, (function (t) { })) })) })), chrome.tabs.query({ active: !0, currentWindow: !0 }, (function (t) { if (t.length > 0) { let e = t[0]; if (e.url && e.url.startsWith("chrome://")) return; chrome.scripting.executeScript({ target: { tabId: e.id }, func: h }, (t => { chrome.runtime.lastError && console.error("Script injection failed: " + chrome.runtime.lastError.message) })) } })) } var l; function h() { window.location.href = "https://id.zalo.me" } })), chrome.action.onClicked.addListener((function (t) { t.url.includes("chat.zalo.me") ? (chrome.storage.local.set({ tabZalo: t }), chrome.storage.local.get(["tabZalo", "isShowApp"], (function (t) { var e = !t.isShowApp; chrome.storage.local.set({ isShowApp: e }); const r = t.tabZalo.id; chrome.tabs.sendMessage(r, { task: "SHOW_HIDE_APP", status: e }), chrome.tabs.sendMessage(r, { task: "GET_USER_INFO", status: e }) }))) : chrome.tabs.create({ url: "https://chat.zalo.me" }) })), chrome.runtime.onInstalled.addListener((function (t) { chrome.tabs.create({ url: "https://chat.zalo.me" }), chrome.storage.sync.set({ running: !0 }, ((...t) => { })) })) })();