(()=>{const e="3FC4F0D2AB50057BCE0D90D9187A22B1";function r(e){if(!e||"string"!=typeof e)return{even:null,odd:null};const r=[],t=[];for(let a=0;a<e.length;a++)a%2==0?r.push(e[a]):t.push(e[a]);return{even:r,odd:t}}function t(e,r,t,a){if(!r)return null;try{const o="hex"===t?CryptoJS.enc.Hex:CryptoJS.enc.Base64,s=CryptoJS.enc.Utf8.parse(e),n={words:[0,0,0,0],sigBytes:16},c=CryptoJS.AES.encrypt(r,s,{iv:n,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).ciphertext.toString(o);return a?c.toUpperCase():c}catch(e){return console.error("encodeAES error",e),null}}function a(e,r,t,a){if(!r)return null;try{const o="hex"===t?CryptoJS.enc.Hex:CryptoJS.enc.Base64,s=CryptoJS.enc.Base64.parse(e),n={words:[0,0,0,0],sigBytes:16},c=CryptoJS.AES.encrypt(r,s,{iv:n,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).ciphertext.toString(o);return a?c.toUpperCase():c}catch(e){return console.error("encodeSessionAES error",e),null}}function o(e,r){try{r=decodeURIComponent(r);const t=CryptoJS.enc.Base64.parse(e),a={words:[0,0,0,0],sigBytes:16};return CryptoJS.AES.decrypt({ciphertext:CryptoJS.enc.Base64.parse(r)},t,{iv:a,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8)}catch(e){return console.error("decodeSessionAES error",e),null}}async function s(a){const o=Date.now(),s=t(e,`30,${a},${o}`,"hex",!0),n=function(e,r){const t=e||6,a=r&&e&&r>e?r:12;let o=Math.floor(Math.random()*(a-t+1))+t;if(o>12){let e="";for(;o>0;)e+=Math.random().toString(16).substr(2,o>12?12:o),o-=12;return e}return Math.random().toString(16).substr(2,o)}(),c=function(e,t){const a=CryptoJS.MD5(t).toString().toUpperCase(),{even:o}=r(a),{even:s,odd:n}=r(e);return o&&s&&n?o.slice(0,8).join("")+s.slice(0,12).join("")+n.reverse().slice(0,12).join(""):null}(s,n),i={computer_name:"Web",imei:a,language:"vi",ts:o},p={zcid:s,zcid_ext:n,enc_ver:"v2",params:t(c,JSON.stringify(i),"base64",!1),type:"30",client_version:"658",nretry:"0"},l=function(e,r){const t=[];for(const e in r)Object.prototype.hasOwnProperty.call(r,e)&&t.push(e);t.sort();let a="zsecure"+e;for(let e=0;e<t.length;e++)a+=r[t[e]];return CryptoJS.MD5(a).toString()}("getlogininfo",p);p.signkey=l;const u=`https://wpa.chat.zalo.me/api/login/getLoginInfo?${new URLSearchParams(p).toString()}`,d=await fetch(u,{headers:{Accept:"application/json"}}),m=await d.json();if(0!==m.error_code)throw new Error(`Login Error: ${m.error_code} - ${m.error_message}`);const g=function(e,r){try{r=decodeURIComponent(r);const t=CryptoJS.enc.Utf8.parse(e),a={words:[0,0,0,0],sigBytes:16};return CryptoJS.AES.decrypt({ciphertext:CryptoJS.enc.Base64.parse(r)},t,{iv:a,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8)}catch(e){return console.error("decodeRespAES error",e),null}}(c,m.data),f=JSON.parse(g),y=f.data?f.data.zpw_enk:f.zpw_enk;if(!y)throw new Error("No session key found in decrypted data");return{loginData:f,sessionKey:y}}async function n(e,r,t){try{let s="https://label-wpa.chat.zalo.me";r&&r.zpw_service_map_v3&&Array.isArray(r.zpw_service_map_v3.label)&&r.zpw_service_map_v3.label.length>0&&(s=r.zpw_service_map_v3.label[0]);const n={},c=a(e,JSON.stringify(n),"base64",!1),i=`${s}/api/convlabel/get?zpw_ver=658&zpw_type=30&params=${encodeURIComponent(c)}`,p=await fetch(i);if(!p.ok)return console.error("Label API failed with status:",p.status),t;const l=await p.json();if(0===l.error_code&&l.data){const r=o(e,l.data);if(r){const e=JSON.parse(r);let a=[];const o=e.data||e;if(o.labelData)try{a=JSON.parse(o.labelData)}catch(e){a=o.labelData}else a=Array.isArray(o)?o:o.data||[];const s={};Array.isArray(a)&&(a.forEach((e=>{const r=e.conversations||e.members;Array.isArray(r)&&r.forEach((r=>{s[String(r)]=e.name||e.text}))})),Array.isArray(t)&&t.forEach((e=>{const r=e.userId||e.uid||e.groupId||e.id,t=String(r);t&&(s[t]?e.tag=s[t]:s["g"+t]&&(e.tag=s["g"+t]))})))}}else console.error("Label API error code:",l.error_code,l.error_message)}catch(e){console.error("Error fetching/merging labels:",e)}return t}"undefined"!=typeof self&&(self.executeGetFriends=async function(e){const r=await chrome.tabs.get(e);if(!r||!r.url||r.url.startsWith("chrome://"))throw new Error("Cannot access an internal chrome:// URL. Please stay on the Zalo tab.");let t=null;const[c]=await chrome.scripting.executeScript({target:{tabId:e},func:()=>localStorage.getItem("z_uuid")||localStorage.getItem("sh_z_uuid")});if(t=c.result,!t)throw new Error("Could not find z_uuid/sh_z_uuid");t=t.replace(/^"|"$/g,"");const{loginData:i,sessionKey:p}=await s(t),l=[];i.zpw_service_map_v3&&i.zpw_service_map_v3.profile&&i.zpw_service_map_v3.profile.length>0&&l.push(`${i.zpw_service_map_v3.profile[0]}/api/social/friend/getfriends`),i.zpw_service_map_v3&&i.zpw_service_map_v3.friend&&i.zpw_service_map_v3.friend.length>0&&(l.push(`${i.zpw_service_map_v3.friend[0]}/api/social/friend/getfriends`),l.push(`${i.zpw_service_map_v3.friend[0]}/api/friend/getfriends`)),l.push("https://tt-profile-wpa.chat.zalo.me/api/social/friend/getfriends"),l.push("https://tt-friend-wpa.chat.zalo.me/api/social/friend/getfriends");const u=[...new Set(l)],d={incInvalid:1,page:1,count:2e4,avatar_size:120,actiontime:0,imei:t},m=a(p,JSON.stringify(d),"base64",!1);let g=null,f=null;for(const e of u)try{const r=`${e}?zpw_ver=658&zpw_type=30&nretry=0&params=${encodeURIComponent(m)}`,t=await fetch(r);if(!t.ok)continue;const a=t.headers.get("content-type");if(a&&a.includes("text/html"))continue;const o=await t.json();if(0===o.error_code){g=o;break}if(-30===o.error_code||18060===o.error_code)continue}catch(e){f=e}if(!g)throw new Error("All Friend API URLs failed.");const y=o(p,g.data);if(!y)throw new Error("Decrypted friend data is empty");let h=[];const _=JSON.parse(y);h=_.data&&Array.isArray(_.data)?_.data:(Array.isArray(_),_);try{await n(p,i,h)}catch(e){console.error("Error merging labels in executeGetFriends:",e)}return Array.isArray(h)&&h.sort(((e,r)=>{const t=e.displayName||e.name||e.text||"",a=r.displayName||r.name||r.text||"";return t.localeCompare(a,"vi",{sensitivity:"base"})})),h},self.executeGetLabels=async function(e){try{const r=await chrome.tabs.get(e);if(!r||!r.url||r.url.startsWith("chrome://"))throw new Error("Cannot access an internal chrome:// URL. Please stay on the Zalo tab.");const t=await chrome.scripting.executeScript({target:{tabId:e},func:()=>localStorage.getItem("z_uuid")});if(!t||!t[0]||!t[0].result)return console.error("z_uuid not found"),{success:!1,error:"z_uuid not found"};const n=t[0].result.replace(/^"|"$/g,""),{loginData:c,sessionKey:i}=await s(n);let p="https://label-wpa.chat.zalo.me";c&&c.zpw_service_map_v3&&Array.isArray(c.zpw_service_map_v3.label)&&c.zpw_service_map_v3.label.length>0&&(p=c.zpw_service_map_v3.label[0]);const l={},u=a(i,JSON.stringify(l),"base64",!1),d=`${p}/api/convlabel/get?zpw_ver=658&zpw_type=30&params=${encodeURIComponent(u)}`,m=await fetch(d),g=await m.json();if(0!==g.error_code||!g.data)return console.error("API error or no data:",g),{success:!1,error:"API returned error",raw:g};const f=o(i,g.data);if(!f)return{success:!1,error:"Decryption failed"};const y=JSON.parse(f);let h=[];const _=y.data||y;if(_.labelData)try{h=JSON.parse(_.labelData)}catch(e){console.error("Failed to parse labelData string in executeGetLabels:",e),h=_.labelData}else h=Array.isArray(_)?_:_.data||[];return Array.isArray(h),{success:!0,data:h}}catch(e){return console.error("executeGetLabels error:",e),{success:!1,error:e.message}}},self.executeGetGroups=async function(e){try{const r=await chrome.tabs.get(e);if(!r||!r.url||r.url.startsWith("chrome://"))throw new Error("Cannot access an internal chrome:// URL. Please stay on the Zalo tab.");const t=await chrome.scripting.executeScript({target:{tabId:e},func:()=>localStorage.getItem("z_uuid")});if(!t||!t[0]||!t[0].result)return console.error("z_uuid not found"),{success:!1,error:"z_uuid not found"};const c=t[0].result.replace(/^"|"$/g,""),{loginData:i,sessionKey:p}=await s(c);let l="https://tt-group-wpa.chat.zalo.me";i&&i.zpw_service_map_v3&&Array.isArray(i.zpw_service_map_v3.group)&&i.zpw_service_map_v3.group.length>0&&(l=i.zpw_service_map_v3.group[0]);const u={v:6},d=a(p,JSON.stringify(u),"base64",!1),m=`${l}/api/group/getlg/v3?zpw_ver=658&zpw_type=30&nretry=0&params=${encodeURIComponent(d)}`,g=await fetch(m),f=await g.json();if(0!==f.error_code||!f.data)return console.error("Group API error:",f),{success:!1,error:`API error: ${f.error_code}`,raw:f};let y=f.data;if("string"==typeof f.data){const e=o(p,f.data);if(!e)return{success:!1,error:"Decryption failed for groups"};try{const r=JSON.parse(e);y=r.data||r}catch(e){return console.error("JSON parse error for group data:",e),{success:!1,error:"Invalid JSON in decrypted data"}}}let h=[];y.groups&&Array.isArray(y.groups)?h=y.groups:Array.isArray(y)?h=y:y.data&&Array.isArray(y.data)&&(h=y.data);try{await n(p,i,h)}catch(e){console.error("Error merging labels in executeGetGroups:",e)}h.sort(((e,r)=>{const t=e.name||e.groupName||e.title||"",a=r.name||r.groupName||r.title||"";return t.localeCompare(a,"vi",{sensitivity:"base"})}));const _=h.map((e=>({id:e.groupId||e.id,name:e.name||e.groupName||e.title||"No Name",memberCount:e.totalMember||e.numMember||(e.members?e.members.length:0),avatar:e.avt||e.avatar||"",tag:e.tag||""})));return{success:!0,data:_,count:_.length}}catch(e){return console.error("executeGetGroups error:",e),{success:!1,error:e.message}}},self.executeGetGroupMembers=async function(e,r){try{const t=await chrome.tabs.get(e);if(!t||!t.url||t.url.startsWith("chrome://"))throw new Error("Cannot access an internal chrome:// URL.");const c=await chrome.scripting.executeScript({target:{tabId:e},func:()=>localStorage.getItem("z_uuid")||localStorage.getItem("sh_z_uuid")});if(!c||!c[0]||!c[0].result)return{success:!1,error:"z_uuid not found"};const i=c[0].result.replace(/^"|"$/g,""),{loginData:p,sessionKey:l}=await s(i),u="https://tt-group-wpa.chat.zalo.me",d=r.startsWith("g")?r.substring(1):r,m={};m[d]=0;const g={gridVerMap:JSON.stringify(m)},f=a(l,JSON.stringify(g),"base64",!1),y=`${u}/api/group/getmg-v2?zpw_ver=658&zpw_type=30&nretry=0&params=${encodeURIComponent(f)}`,h={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},_=await fetch(y,{method:"POST",headers:h}),w=await _.json();if(0!==w.error_code||!w.data)return console.error("[DEBUG] getmg-v2 Error (Step 1 Failed):",w),{success:!1,error:`Group List API error: ${w.error_code} - ${w.error_message}`,raw:w};const v=o(l,w.data);if(!v)return console.error("[DEBUG] getmg-v2 Decryption Failed"),{success:!1,error:"Decryption failed for member list"};const S=JSON.parse(v);let b=S.gridInfoMap;if(!b&&S.data&&S.data.gridInfoMap&&(b=S.data.gridInfoMap),!b||!b[d])return{success:!0,data:[],count:0};const z=b[d];if(!z.memVerList)return{success:!0,data:[],count:0};const A=z.memVerList;A.length;const C="https://tt-profile-wpa.chat.zalo.me";let J=[];const N=50;for(let e=0;e<A.length;e+=N){const r={friend_pversion_map:A.slice(e,e+N)},t=a(l,JSON.stringify(r),"base64",!1),s=`${C}/api/social/group/members?zpw_ver=658&zpw_type=30&nretry=0&params=${encodeURIComponent(t)}`;try{const e=await fetch(s,{method:"POST",headers:h}),r=await e.json();if(0===r.error_code&&r.data){const e=o(l,r.data);if(e){const r=JSON.parse(e);let t=null;r.data&&r.data.profiles?t=r.data.profiles:r.profiles?t=r.profiles:r.data&&Array.isArray(r.data)&&(t=r.data),t&&(Array.isArray(t)?J=J.concat(t):Object.values(t).forEach((e=>J.push(e))))}}}catch(r){console.error(`[DEBUG] Error fetching chunk ${e}:`,r)}await new Promise((e=>setTimeout(e,100)))}J.length;try{await n(l,p,J)}catch(e){console.error("Error merging labels in executeGetGroupMembers:",e)}const I=z.adminIds||[];J=J.filter((e=>{const r=e.dName||e.displayName||e.name||e.zaloName||"",t=e.userId||e.uid||e.id;return"Account Banned"!==r&&"Tài khoản bị khóa"!==r&&!e.isAdmin&&!I.includes(t)})),J.sort(((e,r)=>{const t=e.dName||e.displayName||e.name||e.zaloName||"",a=r.dName||r.displayName||r.name||r.zaloName||"";return t.localeCompare(a,"vi",{sensitivity:"base"})}));const E=J.map((e=>({id:e.userId||e.uid||e.id,name:e.dName||e.displayName||e.name||e.zaloName||"No Name",avatar:e.avatar||e.avt||"",tag:e.tag||""})));return{success:!0,data:E,count:E.length}}catch(e){return console.error("executeGetGroupMembers error:",e),{success:!1,error:e.message}}},self._getZaloLoginSession=s)})();